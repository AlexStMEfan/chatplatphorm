# Stage 1: Build
FROM rust:1.92-slim AS builder

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Rust + Kafka + PostgreSQL
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        libpq-dev \
        pkg-config \
        # üîë –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è rdkafka-sys:
        build-essential \
        libssl-dev \
        libsasl2-dev \
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        cmake \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY . .

ENV SQLX_OFFLINE=true

RUN cargo build --release --locked

# Stage 2: Runtime
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        libpq5 \
        # üîë librdkafka.so –Ω—É–∂–µ–Ω –≤ runtime!
        librdkafka1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
# ‚ö†Ô∏è –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏–º—è –±–∏–Ω–∞—Ä–Ω–∏–∫–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å chat-service, –∞ –Ω–µ auth-service
COPY --from=builder /app/target/release/chat-service /usr/local/bin/chat-service

EXPOSE 8081
CMD ["chat-service"]