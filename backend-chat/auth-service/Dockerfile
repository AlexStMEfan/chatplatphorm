# Stage 1: Build
FROM rust:1.92-slim AS builder

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        libpq-dev \
        pkg-config \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –í–°–Å: –∏—Å—Ö–æ–¥–Ω–∏–∫–∏, Cargo.*, .env, sqlx-data.json
COPY . .

# üîë –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º –æ–Ω–ª–∞–π–Ω-–ø—Ä–æ–≤–µ—Ä–∫—É
ENV SQLX_OFFLINE=true

# –°–±–æ—Ä–∫–∞
RUN cargo build --release --locked

# Stage 2: Runtime
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends ca-certificates libpq5 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /app/target/release/auth-service /usr/local/bin/

EXPOSE 8080
CMD ["auth-service"]